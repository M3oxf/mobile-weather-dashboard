<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0d4d73" />
  <title>Mobile Weather Dashboard</title>

  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="favicon.ico" />

  <style>
  /* ========= START: base + layout ========= */
  :root{
    --bg: #0b2230;
    --panel: #0e2e44;
    --card: #12354e;
    --text: #eaf6ff;
    --muted:#9cc6de;
    --accent:#2aa9ff;
    --ok:#24c27a;
    --warn:#f3c746;
    --bad:#ff5a6b;
    --shadow: 0 8px 20px rgba(0,0,0,.25);
    --radius:16px;
  }
  :root.light {
    --bg:#f4f7fb; --panel:#0d4d73; --card:#ffffff; --text:#0b2230; --muted:#5b7382; --accent:#0d7dc7;
    --shadow: 0 8px 16px rgba(13,77,115,.12);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text); font:15px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif;
    -webkit-tap-highlight-color: transparent;
  }
  a{color:inherit}
  .app{max-width:1024px;margin:0 auto;min-height:100%;display:flex;flex-direction:column}

  /* top bar */
  .topbar{
    position:sticky; top:0; z-index:5; background:var(--panel); box-shadow:var(--shadow);
    padding:10px 12px 12px; border-radius:0 0 var(--radius) var(--radius);
  }
  /* ========= END: base + layout ========= */


  /* ========= START: search + buttons (improved look) ========= */
  .search-row{display:flex; gap:10px; align-items:center}
  .search{
    flex:1; display:flex; align-items:center; gap:10px; background:var(--card); border-radius:999px; padding:8px 12px; box-shadow:var(--shadow);
  }
  .search svg{width:18px;height:18px;opacity:.7;flex:none}
  .search input{
    flex:1; border:0; outline:0; background:transparent; color:var(--text); font:16px;
  }
  .btn-icon{
    width:40px;height:40px;border-radius:999px;border:0;cursor:pointer;background:var(--card);color:var(--text);
    display:inline-grid; place-items:center; box-shadow:var(--shadow);
  }
  .btn-icon:hover{filter:brightness(1.05)}
  .btn-icon:active{transform:scale(.98)}
  .seg{
    display:flex; gap:6px; background:var(--card); border-radius:999px; padding:4px; box-shadow:var(--shadow)
  }
  .seg button{
    min-width:46px; padding:8px 10px;border-radius:999px;border:0;background:transparent;color:var(--text);cursor:pointer;font-weight:600;
  }
  .seg button.active{background:var(--accent); color:white}
  .tog-dark{margin-left:auto}
  /* ========= END: search + buttons ========= */


  /* ========= START: tabs (days) ========= */
  .days{display:flex; gap:8px; padding:10px 12px}
  .days button{
    padding:8px 10px; border-radius:999px; border:0; background:var(--card); color:var(--text); cursor:pointer; font-weight:600;
  }
  .days button.active{background:var(--accent); color:#fff}
  /* ========= END: tabs ========= */


  /* ========= START: grid cards ========= */
  .grid{display:grid; gap:10px; padding:0 12px 10px}
  @media(min-width:640px){ .grid{grid-template-columns:repeat(3,1fr)} }
  @media(min-width:860px){ .grid{grid-template-columns:repeat(4,1fr)} }
  .card{
    background:var(--card); border-radius:14px; padding:14px; box-shadow:var(--shadow); min-height:92px;
    display:flex; flex-direction:column; justify-content:space-between;
  }
  .card h4{margin:0 0 6px; font-size:13px; color:var(--muted); font-weight:700; letter-spacing:.02em}
  .card .val{font-size:22px; font-weight:800}
  .dial{width:84px;height:84px;border-radius:50%; border:3px solid rgba(255,255,255,.15); display:grid; place-items:center}
  .dial .needle{width:2px;height:34px;background:var(--accent); transform-origin:bottom center; border-radius:2px}
  /* ========= END: grid cards ========= */


  /* ========= START: Safe-to-fly banner ========= */
  .s2f{
    display:flex; align-items:center; gap:12px; padding:14px; border-radius:14px; box-shadow:var(--shadow); background:var(--card);
  }
  .s2f .dot{width:14px;height:14px;border-radius:999px}
  .s2f.ok  .dot{background:var(--ok)}
  .s2f.warn .dot{background:var(--warn)}
  .s2f.bad .dot{background:var(--bad)}
  .s2f b{font-size:16px}
  .s2f ul{margin:6px 0 0 0; padding-left:18px; color:var(--muted)}
  /* ========= END: Safe-to-fly banner ========= */


  /* ========= START: hours selector (wrap to 2 rows on small) ========= */
  .hours{display:flex; flex-wrap:wrap; gap:8px; padding:10px 12px 18px}
  .hour{
    width:44px; height:36px; display:grid; place-items:center; border-radius:10px; background:var(--card); color:var(--text); cursor:pointer;
    user-select:none; box-shadow:var(--shadow); font-weight:700;
  }
  .hour.active{background:var(--accent); color:#fff}
  /* ========= END: hours selector ========= */

  .footnote{opacity:.6; font-size:12px; padding:0 12px 18px}
  </style>
</head>
<body>
  <div class="app">

    <!-- ======== START: TOP BAR ======== -->
    <div class="topbar">
      <div class="search-row">
        <div class="search" style="flex:1">
          <!-- search icon -->
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="7"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
          <input id="q" placeholder="Search location..." autocomplete="off" />
        </div>

        <!-- prettier GPS + Clear buttons -->
        <button id="btnGPS" class="btn-icon" title="Use GPS">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M12 2v3M12 19v3M2 12h3M19 12h3M4.22 4.22l2.12 2.12M17.66 17.66l2.12 2.12M4.22 19.78l2.12-2.12M17.66 6.34l2.12-2.12"/>
          </svg>
        </button>
        <button id="btnSearch" class="btn-icon" title="Search">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="7"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
        </button>

        <!-- unit toggles -->
        <div class="seg" id="uSpeed" title="Speed units">
          <button data-u="kmh" class="active">km/h</button>
          <button data-u="mph">mph</button>
        </div>
        <div class="seg" id="uTemp" title="Temperature units">
          <button data-u="C" class="active">°C</button>
          <button data-u="F">°F</button>
        </div>

        <!-- dark mode toggle -->
        <button id="btnDark" class="btn-icon tog-dark" title="Toggle dark mode">🌙</button>
      </div>
    </div>
    <!-- ======== END: TOP BAR ======== -->

    <!-- ======== START: CURRENT LOCATION / DAY TABS ======== -->
    <div class="days" id="days"></div>
    <!-- ======== END: CURRENT LOCATION / DAY TABS ======== -->

    <!-- ======== START: SAFE-TO-FLY BANNER ======== -->
    <div id="s2f" class="s2f ok" style="margin:0 12px 10px">
      <span class="dot"></span>
      <div>
        <b id="s2fTitle">Safe to fly</b>
        <ul id="s2fNotes"></ul>
      </div>
    </div>
    <!-- ======== END: SAFE-TO-FLY BANNER ======== -->

    <!-- ======== START: GRID ======== -->
    <div class="grid" id="grid">
      <!-- Cards will be filled by JS -->
    </div>
    <!-- ======== END: GRID ======== -->

    <!-- ======== START: HOURS (wraps on small) ======== -->
    <div class="hours" id="hours"></div>
    <!-- ======== END: HOURS ======== -->

    <div class="footnote">Data: Open-Meteo — No API key needed.</div>
  </div>

  <script>
  // ========= START: tiny helpers =========
  const $ = sel => document.querySelector(sel);
  const el = (tag, cls) => Object.assign(document.createElement(tag), { className: cls||'' });
  const kmhToMph = v => v*0.621371;
  const cToF = v => (v*9/5)+32;
  const clamp = (v,a,b)=>Math.min(b,Math.max(a,v));
  const vibrate = ms => { if (navigator.vibrate) navigator.vibrate(ms); };
  // ========= END: tiny helpers =========

  // ========= START: state =========
  const state = {
    lat: 51.7522, lon: -1.2577, // default Oxford
    place: "Oxford, United Kingdom",
    dayIdx: 0,
    hourIdx: new Date().getHours(),
    uSpeed: localStorage.getItem('uSpeed') || 'kmh',
    uTemp: localStorage.getItem('uTemp') || 'C',
    dark: localStorage.getItem('dark') || 'dark', // 'dark' or 'light'
    data: null
  };
  if (state.dark === 'light') document.documentElement.classList.add('light');
  // ========= END: state =========


  // ========= START: build UI skeleton (cards, hours, days) =========
  const cardsSpec = [
    {id:'weather', label:'Weather', fmt: v => v },
    {id:'cloud', label:'Cloud cover', fmt: v => v + '%' },
    {id:'visibility', label:'Visibility', fmt: v => (v>=10 ? '10+ km' : v.toFixed(1)+' km') },
    {id:'wind', label:'Wind', fmt: v => v.toFixed(0) + ' ' + (state.uSpeed==='mph'?'mph':'km/h') },
    {id:'gust', label:'Gust (hour)', fmt: v => v.toFixed(0) + ' ' + (state.uSpeed==='mph'?'mph':'km/h') },
    {id:'wdir', label:'Wind direction', dial:true },
    {id:'precip', label:'Precipitation', fmt: v => v.toFixed(1)+' mm' },
    {id:'pop', label:'Precip probability', fmt: v => v + '%' },
    {id:'feels', label:'Feels like', fmt: v => (state.uTemp==='F'?cToF(v):v).toFixed(0) + '°' },
    {id:'humidity', label:'Humidity', fmt: v => v + '%' },
    {id:'sun', label:'Sunrise / Sunset', fmt: v => v },
    {id:'uv', label:'UV index', fmt: v => v.toFixed(0) },
    {id:'pressure', label:'Pressure', fmt: v => v.toFixed(0)+' hPa' }
  ];

  function buildGrid(){
    const g = $('#grid'); g.innerHTML='';
    for(const c of cardsSpec){
      const card = el('div','card'); card.id = 'card-'+c.id;
      const h = el('h4'); h.textContent = c.label; card.appendChild(h);
      if (c.dial){
        const dial = el('div','dial'); const needle = el('div','needle'); dial.appendChild(needle); card.appendChild(dial);
      }else{
        const v = el('div','val'); v.textContent='—'; card.appendChild(v);
      }
      g.appendChild(card);
    }
  }

  function buildHours(){
    const wrap = $('#hours'); wrap.innerHTML='';
    for(let h=0; h<24; h++){
      const b = el('div','hour'); b.textContent=String(h).padStart(2,'0');
      if (h===state.hourIdx) b.classList.add('active');
      b.onclick = () => { state.hourIdx=h; setActiveHour(); render(); vibrate(12); };
      b.oncontextmenu = (e)=>{ e.preventDefault(); state.hourIdx=new Date().getHours(); setActiveHour(); render(); };
      wrap.appendChild(b);
    }
  }
  function setActiveHour(){
    $('#hours').querySelectorAll('.hour').forEach((n,i)=>n.classList.toggle('active',i===state.hourIdx));
  }

  function buildDays(){
    const wrap = $('#days'); wrap.innerHTML='';
    const dt = state.data?.daily?.time?.map(t=>new Date(t)) || [];
    const names = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    for(let i=0;i<Math.min(7,dt.length);i++){
      const d = dt[i];
      const b = el('button'); b.textContent = (i===0?'Today':names[d.getDay()]);
      if (i===state.dayIdx) b.classList.add('active');
      b.onclick = ()=>{ state.dayIdx=i; buildDays(); render(); };
      wrap.appendChild(b);
    }
  }
  // ========= END: build UI skeleton =========


  // ========= START: data fetch =========
  async function geocode(q){
    const url = `https://geocoding-api.open-meteo.com/v1/search?count=1&language=en&format=json&name=${encodeURIComponent(q)}`;
    const r = await fetch(url); if(!r.ok) throw new Error('geocode failed');
    const j = await r.json();
    if(!j.results?.length) throw new Error('location not found');
    const { latitude:lat, longitude:lon, name, country, admin1 } = j.results[0];
    return { lat, lon, place: [name, admin1, country].filter(Boolean).join(', ') };
  }

  async function getWeather(lat,lon){
    const params = new URLSearchParams({
      latitude: lat, longitude: lon, timezone: 'auto',
      hourly: [
        'temperature_2m','apparent_temperature','relative_humidity_2m',
        'precipitation_probability','rain','cloud_cover',
        'wind_speed_10m','wind_gusts_10m','wind_direction_10m',
        'pressure_msl','visibility','uv_index'
      ].join(','),
      daily: ['sunrise','sunset','uv_index_max'].join(',')
    });
    const url = `https://api.open-meteo.com/v1/forecast?${params.toString()}`;
    const r = await fetch(url); if(!r.ok) throw new Error('forecast failed');
    return await r.json();
  }
  // ========= END: data fetch =========


  // ========= START: safety logic =========
  // Heuristics for small drones (tweak if you want)
  function evaluateSafety(h){
    const H = state.data.hourly;
    const idx = state.dayIdx*24 + h;

    // Base values (km/h, °C, km)
    const wind = H.wind_speed_10m[idx];
    const gust = H.wind_gusts_10m[idx];
    const pop  = H.precipitation_probability[idx] ?? 0;
    const visKm = Math.min(10, (H.visibility[idx]||0) / 1000); // cap at 10+ km
    const temp = H.temperature_2m[idx];

    let score = 100, notes=[];

    // Wind
    if (gust >= 60) { score -= 70; notes.push(`Very strong gusts ${fmtSpeed(gust)}`); }
    else if (gust >= 45) { score -= 40; notes.push(`Gusty ${fmtSpeed(gust)}`); }

    if (wind >= 40) { score -= 40; notes.push(`Strong wind ${fmtSpeed(wind)}`); }
    else if (wind >= 28) { score -= 20; notes.push(`Moderate wind ${fmtSpeed(wind)}`); }

    // Precipitation probability
    if (pop >= 60){ score -= 50; notes.push(`High precip prob ${pop}%`); }
    else if (pop >= 30){ score -= 20; notes.push(`Chance of precip ${pop}%`); }

    // Visibility
    if (visKm < 5){ score -= 40; notes.push(`Low visibility ${visKm.toFixed(1)} km`); }
    else if (visKm < 10){ score -= 15; notes.push(`Visibility ${visKm.toFixed(1)} km`); }

    // Temperature extremes (battery/icing risk)
    if (temp <= -5){ score -= 25; notes.push(`Very cold ${fmtTemp(temp)}`); }
    else if (temp <= 0){ score -= 15; notes.push(`Cold ${fmtTemp(temp)}`); }
    if (temp >= 35){ score -= 25; notes.push(`Very hot ${fmtTemp(temp)}`); }

    // Outcome
    let status='ok';
    if (score < 50) status='bad';
    else if (score < 75) status='warn';
    return { status, notes };
  }
  // ========= END: safety logic =========


  // ========= START: formatting helpers =========
  function fmtSpeed(vKmh){
    const v = (state.uSpeed==='mph') ? kmhToMph(vKmh) : vKmh;
    return `${v.toFixed(0)} ${state.uSpeed}`;
  }
  function fmtTemp(c){
    return (state.uTemp==='F' ? `${cToF(c).toFixed(0)}°F` : `${c.toFixed(0)}°C`);
  }
  // ========= END: formatting helpers =========


  // ========= START: render =========
  function render(){
    if (!state.data) return;

    // days / hours present
    buildDays(); setActiveHour();

    const H = state.data.hourly;
    const D = state.data.daily;
    const i = state.dayIdx*24 + state.hourIdx;

    // Safe-to-fly banner
    const s = evaluateSafety(state.hourIdx);
    const s2f = $('#s2f');
    s2f.classList.remove('ok','warn','bad'); s2f.classList.add(s.status);
    $('#s2fTitle').textContent = s.status==='ok' ? 'Safe to fly' : s.status==='warn' ? 'Caution' : 'No-fly';
    $('#s2fNotes').innerHTML = s.notes.slice(0,4).map(n=>`<li>${n}</li>`).join('') || '<li>All good.</li>';

    // Weather summary (super simple icon-less)
    $('#card-weather .val')?.replaceWith(Object.assign(el('div','val'),{textContent: `${fmtTemp(H.temperature_2m[i])}`}));

    // Cloud cover
    $('#card-cloud .val').textContent = (H.cloud_cover[i] ?? 0) + '%';

    // Visibility km (cap display at 10+)
    const visKm = clamp((H.visibility[i]||0)/1000, 0, 10);
    $('#card-visibility .val').textContent = visKm>=10 ? '10+ km' : visKm.toFixed(1) + ' km';

    // Wind / gust / dir
    const wind = H.wind_speed_10m[i] || 0;
    const gust = H.wind_gusts_10m[i] || 0;
    $('#card-wind .val').textContent = fmtSpeed(wind);
    $('#card-gust .val').textContent = fmtSpeed(gust);
    const dir = H.wind_direction_10m[i] || 0;
    const needle = $('#card-wdir .needle'); if (needle) needle.style.transform = `rotate(${dir}deg)`;

    // Precip + POP
    $('#card-precip .val').textContent = ((H.rain[i]||0)).toFixed(1) + ' mm';
    $('#card-pop .val').textContent = (H.precipitation_probability[i] ?? 0) + '%';

    // Feels like
    const feels = H.apparent_temperature[i] ?? H.temperature_2m[i];
    $('#card-feels .val').textContent = fmtTemp(feels);

    // Humidity
    $('#card-humidity .val').textContent = (H.relative_humidity_2m[i] ?? 0) + '%';

    // Pressure
    $('#card-pressure .val').textContent = (H.pressure_msl[i] ?? 0).toFixed(0) + ' hPa';

    // UV
    $('#card-uv .val').textContent = (H.uv_index[i] ?? (D.uv_index_max[state.dayIdx]||0)).toFixed(0);

    // Sun
    const sr = new Date(D.sunrise[state.dayIdx]); const ss = new Date(D.sunset[state.dayIdx]);
    const pad = n=>String(n).padStart(2,'0');
    const hhmm = d => `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    $('#card-sun .val').textContent = `${hhmm(sr)} / ${hhmm(ss)}`;

    // Save prefs
    localStorage.setItem('uSpeed', state.uSpeed);
    localStorage.setItem('uTemp', state.uTemp);
    localStorage.setItem('dark', document.documentElement.classList.contains('light') ? 'light' : 'dark');
    localStorage.setItem('lastPlace', JSON.stringify({lat:state.lat,lon:state.lon,place:state.place}));
  }
  // ========= END: render =========


  // ========= START: actions (search, gps, units, dark) =========
  async function doSearch(){
    const q = $('#q').value.trim();
    if (!q) return;
    try{
      const g = await geocode(q);
      state.lat=g.lat; state.lon=g.lon; state.place=g.place;
      await loadAndRender();
    }catch(e){ alert('Location not found'); }
  }

  async function doGPS(){
    if (!navigator.geolocation) return alert('GPS not available');
    navigator.geolocation.getCurrentPosition(async pos=>{
      state.lat=pos.coords.latitude; state.lon=pos.coords.longitude; state.place='Current location';
      await loadAndRender();
    }, err=> alert('GPS failed'));
  }

  $('#btnSearch').onclick = doSearch;
  $('#q').addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });
  $('#btnGPS').onclick = ()=>{ vibrate(12); doGPS(); };

  $('#uSpeed').addEventListener('click', e=>{
    const b = e.target.closest('button'); if(!b)return;
    state.uSpeed=b.dataset.u;
    [...$('#uSpeed').children].forEach(n=>n.classList.toggle('active',n===b));
    render();
  });
  $('#uTemp').addEventListener('click', e=>{
    const b = e.target.closest('button'); if(!b)return;
    state.uTemp=b.dataset.u;
    [...$('#uTemp').children].forEach(n=>n.classList.toggle('active',n===b));
    render();
  });
  $('#btnDark').onclick = ()=>{
    const light = document.documentElement.classList.toggle('light');
    $('#btnDark').textContent = light ? '☀️' : '🌙';
    render();
  };
  // ========= END: actions =========


  // ========= START: load & boot =========
  async function loadAndRender(){
    buildGrid(); buildHours();
    try{
      state.data = await getWeather(state.lat, state.lon);
      render();
    }catch(e){
      console.error(e);
      alert('Failed to load weather data.');
    }
  }

  // Restore last location/units
  (function boot(){
    const last = localStorage.getItem('lastPlace');
    if (last){ try{ const j=JSON.parse(last); Object.assign(state,{lat:j.lat,lon:j.lon,place:j.place}); }catch{} }
    [...$('#uSpeed').children].forEach(n=>n.classList.toggle('active', n.dataset.u===state.uSpeed));
    [...$('#uTemp').children].forEach(n=>n.classList.toggle('active', n.dataset.u===state.uTemp));
    $('#btnDark').textContent = document.documentElement.classList.contains('light') ? '☀️' : '🌙';
    loadAndRender();
  })();
  // ========= END: load & boot =========


  // ========= START: PWA registration =========
  if ('serviceWorker' in navigator){
    window.addEventListener('load', ()=>navigator.serviceWorker.register('./sw.js'));
  }
  // ========= END: PWA registration =========
  </script>
</body>
</html>
